{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/form.schema.json",
  "title": "Form Definition Schema",
  "type": "object",
  "required": [
    "form_id",
    "title",
    "fields"
  ],
  "additionalProperties": false,
  "properties": {
    "form_id": {
      "type": "string",
      "pattern": "^[a-z0-9_]{3,64}$"
    },
    "title": {
      "type": "string"
    },
    "description": {
      "type": "string",
      "default": ""
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+(\\.[0-9]+){0,2}$"
    },
    "locales": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[a-z]{2}(-[A-Z]{2})?$"
      },
      "uniqueItems": true
    },
    "aliases": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "uniqueItems": true
    },
    "pdf_template": {
      "type": "string"
    },
    "ui": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "font_size_pt": {
          "type": "number",
          "minimum": 10,
          "maximum": 32,
          "default": 16
        },
        "line_height": {
          "type": "number",
          "minimum": 1.2,
          "maximum": 2.0,
          "default": 1.6
        },
        "high_contrast": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "style": {
      "type": "object",
      "description": "Visual style and layout information for form preview and PDF generation",
      "additionalProperties": false,
      "properties": {
        "header": {
          "type": "object",
          "properties": {
            "logo_url": {
              "type": "string",
              "format": "uri"
            },
            "organization": {
              "type": "string"
            },
            "department": {
              "type": "string"
            },
            "address": {
              "type": "string"
            },
            "align": {
              "type": "string",
              "enum": ["left", "center", "right"],
              "default": "center"
            }
          }
        },
        "title": {
          "type": "object",
          "properties": {
            "text": {
              "type": "string"
            },
            "font_size": {
              "type": "string",
              "pattern": "^\\d+(px|pt|em|rem)$"
            },
            "font_weight": {
              "type": "string",
              "enum": ["normal", "bold", "100", "200", "300", "400", "500", "600", "700", "800", "900"]
            },
            "text_transform": {
              "type": "string",
              "enum": ["none", "uppercase", "lowercase", "capitalize"]
            },
            "margin_bottom": {
              "type": "string"
            },
            "align": {
              "type": "string",
              "enum": ["left", "center", "right"]
            }
          }
        },
        "layout": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["single-column", "two-column", "grid", "table"],
              "default": "single-column"
            },
            "columns": {
              "type": "integer",
              "minimum": 1,
              "maximum": 3
            },
            "field_spacing": {
              "type": "string",
              "description": "CSS margin/padding value"
            },
            "label_position": {
              "type": "string",
              "enum": ["top", "left", "inline"],
              "default": "top"
            },
            "label_width": {
              "type": "string",
              "description": "Width of label when position is 'left'"
            }
          }
        },
        "colors": {
          "type": "object",
          "properties": {
            "primary": {
              "type": "string",
              "pattern": "^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$"
            },
            "secondary": {
              "type": "string",
              "pattern": "^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$"
            },
            "text": {
              "type": "string",
              "pattern": "^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$"
            },
            "background": {
              "type": "string",
              "pattern": "^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$"
            },
            "border": {
              "type": "string",
              "pattern": "^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$"
            }
          }
        },
        "fonts": {
          "type": "object",
          "properties": {
            "family": {
              "type": "string",
              "default": "Arial, sans-serif"
            },
            "heading_family": {
              "type": "string"
            },
            "body_size": {
              "type": "string"
            },
            "label_size": {
              "type": "string"
            }
          }
        },
        "spacing": {
          "type": "object",
          "properties": {
            "page_margin": {
              "type": "string"
            },
            "section_gap": {
              "type": "string"
            },
            "field_gap": {
              "type": "string"
            }
          }
        },
        "footer": {
          "type": "object",
          "properties": {
            "show_signature_lines": {
              "type": "boolean",
              "default": true
            },
            "signature_labels": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "label": {
                    "type": "string"
                  },
                  "position": {
                    "type": "string",
                    "enum": ["left", "center", "right"]
                  }
                }
              }
            },
            "show_date": {
              "type": "boolean",
              "default": true
            },
            "notes": {
              "type": "string"
            }
          }
        }
      }
    },
    "ocr_metadata": {
      "type": "object",
      "description": "Metadata from OCR scanning of physical form",
      "additionalProperties": false,
      "properties": {
        "source_file": {
          "type": "string",
          "description": "Original scanned file name"
        },
        "scan_date": {
          "type": "string",
          "format": "date-time"
        },
        "ocr_engine": {
          "type": "string",
          "description": "OCR engine used (e.g., Tesseract, Google Vision, Azure)"
        },
        "ocr_version": {
          "type": "string"
        },
        "confidence_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Overall OCR confidence (0-1)"
        },
        "language": {
          "type": "string",
          "default": "vi"
        },
        "page_count": {
          "type": "integer",
          "minimum": 1
        },
        "dimensions": {
          "type": "object",
          "properties": {
            "width": {
              "type": "integer",
              "description": "Original image width in pixels"
            },
            "height": {
              "type": "integer",
              "description": "Original image height in pixels"
            },
            "dpi": {
              "type": "integer"
            }
          }
        },
        "preprocessing": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["deskew", "denoise", "binarization", "contrast_enhancement", "rotation"]
          }
        },
        "field_regions": {
          "type": "array",
          "description": "Bounding boxes of detected fields in original image",
          "items": {
            "type": "object",
            "properties": {
              "field_name": {
                "type": "string"
              },
              "bbox": {
                "type": "object",
                "properties": {
                  "x": {"type": "integer"},
                  "y": {"type": "integer"},
                  "width": {"type": "integer"},
                  "height": {"type": "integer"}
                },
                "required": ["x", "y", "width", "height"]
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              }
            }
          }
        }
      }
    },
    "fields": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/field"
      }
    }
  },
  "$defs": {
    "field": {
      "type": "object",
      "required": [
        "name",
        "label",
        "type",
        "required"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9_]{2,64}$"
        },
        "label": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": [
            "string",
            "multiline",
            "integer",
            "number",
            "date",
            "datetime",
            "email",
            "phone",
            "address",
            "select",
            "radio",
            "checkbox",
            "boolean",
            "file"
          ]
        },
        "required": {
          "type": "boolean"
        },
        "example": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "number"
            },
            {
              "type": "boolean"
            },
            {
              "type": "null"
            }
          ]
        },
        "placeholder": {
          "type": "string"
        },
        "help": {
          "type": "string"
        },
        "default": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "number"
            },
            {
              "type": "boolean"
            },
            {
              "type": "null"
            }
          ]
        },
        "pattern": {
          "type": "string"
        },
        "minLength": {
          "type": "integer",
          "minimum": 0
        },
        "maxLength": {
          "type": "integer",
          "minimum": 1
        },
        "minimum": {
          "type": "number"
        },
        "maximum": {
          "type": "number"
        },
        "min": {
          "type": "string"
        },
        "max": {
          "type": "string"
        },
        "options": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/option"
          }
        },
        "normalizers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "strip_spaces",
              "collapse_whitespace",
              "upper",
              "lower",
              "title_case",
              "vi_normalize_accents"
            ]
          }
        },
        "input_mode": {
          "type": "string",
          "enum": [
            "text",
            "numeric",
            "tel",
            "email",
            "date",
            "datetime"
          ]
        },
        "validators": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/validator"
          }
        },
        "suspicion_rules": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/suspicion_rule"
          }
        },
        "confirm_if_uncertain": {
          "type": "string"
        },
        "style": {
          "type": "object",
          "description": "Field-specific styling",
          "additionalProperties": false,
          "properties": {
            "width": {
              "type": "string",
              "description": "CSS width value"
            },
            "height": {
              "type": "string",
              "description": "CSS height value (for multiline)"
            },
            "font_size": {
              "type": "string"
            },
            "font_weight": {
              "type": "string"
            },
            "text_align": {
              "type": "string",
              "enum": ["left", "center", "right", "justify"]
            },
            "input_style": {
              "type": "string",
              "enum": ["underline", "box", "none"],
              "description": "Visual style of input area"
            },
            "show_border": {
              "type": "boolean"
            },
            "background_color": {
              "type": "string",
              "pattern": "^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$"
            }
          }
        },
        "ocr_data": {
          "type": "object",
          "description": "OCR-extracted data for this field",
          "additionalProperties": false,
          "properties": {
            "extracted_text": {
              "type": "string",
              "description": "Raw text extracted by OCR"
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "bbox": {
              "type": "object",
              "properties": {
                "x": {"type": "integer"},
                "y": {"type": "integer"},
                "width": {"type": "integer"},
                "height": {"type": "integer"}
              }
            },
            "alternatives": {
              "type": "array",
              "description": "Alternative OCR interpretations",
              "items": {
                "type": "object",
                "properties": {
                  "text": {"type": "string"},
                  "confidence": {"type": "number"}
                }
              }
            },
            "requires_review": {
              "type": "boolean",
              "description": "Flag if OCR confidence is low"
            }
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "const": "select"
              }
            }
          },
          "then": {
            "properties": {
              "options": {
                "minItems": 1
              }
            },
            "required": [
              "options"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "radio"
              }
            }
          },
          "then": {
            "properties": {
              "options": {
                "minItems": 1
              }
            },
            "required": [
              "options"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "checkbox"
              }
            }
          },
          "then": {
            "properties": {
              "options": {
                "minItems": 1
              }
            },
            "required": [
              "options"
            ]
          }
        }
      ]
    },
    "option": {
      "type": "object",
      "required": [
        "value",
        "label"
      ],
      "additionalProperties": false,
      "properties": {
        "value": {
          "type": [
            "string",
            "number",
            "boolean"
          ]
        },
        "label": {
          "type": "string"
        }
      }
    },
    "validator": {
      "type": "object",
      "required": [
        "type"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "regex",
            "date_range",
            "length",
            "numeric_range",
            "in_enum"
          ]
        },
        "pattern": {
          "type": "string"
        },
        "message": {
          "type": "string"
        },
        "min": {
          "type": [
            "number",
            "string"
          ]
        },
        "max": {
          "type": [
            "number",
            "string"
          ]
        },
        "allowed": {
          "type": "array",
          "items": {
            "type": [
              "string",
              "number",
              "boolean"
            ]
          }
        }
      },
      "additionalProperties": false,
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "const": "regex"
              }
            }
          },
          "then": {
            "required": [
              "pattern"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "length"
              }
            }
          },
          "then": {
            "required": [
              "min",
              "max"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "numeric_range"
              }
            }
          },
          "then": {
            "required": [
              "min",
              "max"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "date_range"
              }
            }
          },
          "then": {
            "required": [
              "min",
              "max"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "in_enum"
              }
            }
          },
          "then": {
            "required": [
              "allowed"
            ]
          }
        }
      ]
    },
    "suspicion_rule": {
      "type": "object",
      "required": [
        "type"
      ],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "age_outlier",
            "short_address",
            "unlikely_email_domain",
            "low_confidence_input",
            "generic_length_outlier"
          ]
        },
        "min": {
          "type": "number"
        },
        "max": {
          "type": "number"
        },
        "minWords": {
          "type": "number"
        },
        "domainsBlacklist": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "signal": {
          "type": "string"
        },
        "threshold": {
          "type": "number"
        },
        "confirm": {
          "type": "string"
        },
        "hint": {
          "type": "string"
        }
      }
    }
  }
}
